<!doctype html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>Cell mode</title>
</head>
	<script src='../codebase/dhtmlxscheduler.js' type="text/javascript" charset="utf-8"></script>
	<script src="../codebase/ext/dhtmlxscheduler_minical.js" type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_limit.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_minical.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_collision.js' type="text/javascript" charset="utf-8"></script>
	<script src='./dhtmlxscheduler_timeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='./dhtmlxscheduler_treetimeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_units.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_multisection.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_tooltip.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/locale/locale_cn.js' type="text/javascript" charset="utf-8"></script>


	<script src='./jquery-1.12.3.min.js' type="text/javascript" charset="utf-8"></script>
	<script src='./bootstrap.min.js' type="text/javascript" charset="utf-8"></script>
	
	<link rel='stylesheet' type='text/css' href='../codebase/dhtmlxscheduler_flat.css'>
	<link rel="stylesheet" href="./css/bootstrap.min.css">

	
<style type="text/css" media="screen">
	html, body{
		margin:0px;
		padding:0px;
		height:100%;
		overflow:hidden;
	}

	.dhx_matrix_scell.folder .dhx_scell_expand {
	    float: left;
	    width: 15px;
	    height: 11px;
	    /*
	    background-color: #49A223;
	    font-size: 1em;
	    border: 1px solid #fff;
	    */
	    cursor: pointer;
	    padding: 1px 7px 13px 4px;
	    margin-right: 2px;
	    
	    
	}

	.dhx_scale_bar, .dhx_scell_name {
		cursor: default;
		color: #000;
	}

	tr:hover .dhx_matrix_scell.item {
		background-color: #ececec;
		border-bottom: 1px solid #49A223;
		color: #49A223;
		font-weight: bold;
	}

	tr:hover .dhx_matrix_cell {
		background-color: #ececec;
		border-bottom: 1px solid #49A223;
	}

	.dhx_cal_date, .dhx_cal_next_button, .dhx_cal_prev_button, .dhx_cal_tab, .dhx_cal_today_button {
		border: 1px solid #cecece;
	}

	.dhx_cal_tab.active {
		border: 1px solid #5780ad;		
	}

	.dhx_data_table.folder .dhx_matrix_cell, .dhx_matrix_scell.folder {
	    background-color: #ababab;
	    cursor: default;
	    color: #fff;
	    border-right: 1px solid #cecece;
	    font-size: 1.5em;
	}

	.dhx_matrix_scell.item .dhx_scell_name {
	    padding-left: 0px;
	    text-align: left;
	}


	.holiday_section {
		background-image:url(data/imgs/fat_lines.png);
	}
	.weekend_section {
		background-image:url(data/imgs/fat_lines.png);
	}

	.section_1{
		background-color: #49A223;
	}
	.section_2{
		background-color: #e29e2e;
	}
	.section_3{
		background-color: #c53b64;
	}
	.section_4{
		background-color: #6e7dc5;
	}

	.dhx_event_resize{
		display:none;
	}
	.dhx_cal_event_line {
		height:90% !important;
		top: 1px !important;
	}
	.white_cell{
		background-color:white;
	}
	.green_cell{
		background-color:#95FF95;		
	}
	.yellow_cell{
		background-color:#FFFF79;
	}
	.red_cell{
		background-color:#FF5353;
	}
</style>

<script type="text/javascript" charset="utf-8">

	function show_minical(){
		if (scheduler.isCalendarVisible()) {
			scheduler.destroyCalendar();
		} else {
			scheduler.renderCalendar({
				position:"dhx_minical_icon",
				date:scheduler._date,
				navigation:true,
				handler:function(date,calendar){
					scheduler.setCurrentView(date);
					scheduler.destroyCalendar()
				}
			});
		}
	}

	function init() {
		initScheduler(scheduler, 'scheduler_here1', 'matrix', 'WEEK');


	}

	function initScheduler(scheduler, el, tabbtn, tabname) {

		scheduler = scheduler || Scheduler.getSchedulerInstance();

		scheduler.locale.labels[tabbtn+"_tab"] = tabname;
		scheduler.locale.labels.section_custom="Section";
		scheduler.config.details_on_create=true;
		scheduler.config.details_on_dblclick=true;
		scheduler.config.xml_date="%Y-%m-%d %H:%i";
		scheduler.config.api_date="%Y-%m-%d %H:%i";
		scheduler.config.multi_day = true;
		scheduler.config.check_limits = true;
		scheduler.config.collision_limit = 1;
		scheduler.config.drag_create = false;
		scheduler.config.drag_move = false;
		scheduler.config.drag_resize = false;
		scheduler.config.limit_time_select = true;

		//scheduler.config.enable_single_click = true;
		scheduler.config.dblclick_create = true;
		scheduler.config.edit_on_create = false;

		brief_mode = true; 
		
		//intercept_click(scheduler);

		//===============
		//Configuration
		//===============

		var sections = [], groupBy = true;
		if (groupBy) {
			sections=[
				{key:100, label:"CT Group", open: true, children: [
					{key:1, label:"Elizabeth Taylor"},				
					{key:2, label:"Linda Brown"},
					{key:11, label:"Andrea Das"},
					{key:12, label:"Brown Wdae"},
					{key:13, label:"Yaneld deo"}
				]},
				{key:110, label:"MR Group", open:true, children: [
					{key:3, label:"Kate Moss"},
					{key:4, label:"Dian Fossey"},
					{key:15, label:"Dian Fossey2"},
					{key:16, label:"Dian Fossey3"},
					{key:17, label:"Dian Fossey4"}
				]},
				{key:120, label:"DX Group", open:true, children: [
					{key:21, label:"Kate Moss"},
					{key:22, label:"Dian Fossey"},
					{key:23, label:"Dian Fossey2"},
					{key:24, label:"Dian Fossey3"},
					{key:25, label:"Dian Fossey4"},
					{key:26, label:"Dian Fossey5"},
					{key:27, label:"Dian Fossey6"},
					{key:28, label:"Dian Fossey7"}
				]},
				{key:130, label:"US Group", open:true, children: [
					{key:31, label:"Kate Moss"},
					{key:32, label:"Dian Fossey"},
					{key:33, label:"Dian Fossey2"},
					{key:34, label:"Dian Fossey3"},
					{key:35, label:"Dian Fossey4"},
					{key:36, label:"Dian Fossey5"},
					{key:37, label:"Dian Fossey6"},
					{key:38, label:"Dian Fossey7"}
				]}

			];
		} else {
			sections=[ 
				{key:1, label:"Elizabeth Taylor"},
				{key:2, label:"Linda Brown"},
				{key:3, label:"Kate Moss"},
				{key:4, label:"Dian Fossey"},
				{key:15, label:"Dian Fossey2"},
				{key:16, label:"Dian Fossey3"},
				{key:17, label:"Dian Fossey4"}
			];
		}
		
		scheduler.createTimelineView({
			name:	tabbtn,
			render: "tree",
			x_unit:	"hour",
			x_date: "%H",
			x_step:	8,
			x_size: 21,
			section_autoheight: false,
			y_unit:	sections,
			y_property:	"section_id",
			second_scale:{
				x_unit: "day", // unit which should be used for second scale
				x_date: "周%D(%F %d)" // date format which should be used for second scale, "July 01"
			}
		});

		scheduler.createUnitsView({
			name: "unit",
			property: "section_id",
			list: sections
		});
		
		//===============
		//Customization
		//===============

		scheduler.templates.matrix_scale_date = function(date) {
			var hour = (date||new Date()).getHours();
			if (hour < 8) {
				return "早";
			} else if (hour < 16) {
				return "中";
			} else {
				return "晚";
			}
			return "TEST";
		};
		/*
		scheduler.templates.matrix_cell_class = function(evs,x,y){
			if (!evs) {
				var day = x.getDay();
				return (day==0 || day == 6) ? "yellow_cell" : "white_cell";
			}
			if (evs.length<3) return "green_cell";
			if (evs.length<5) return "yellow_cell";
			return "red_cell";
		};
		*/

		scheduler.templates.matrix_scalex_class = function(date){
			if (date.getDay()==0 || date.getDay()==6)  return "weekend_section";
			return "";
		};

		scheduler.templates.matrix_second_scalex_class = function(date){
			if (date.getDay()==0 || date.getDay()==6)  return "weekend_section";
			return "";
		};	

		scheduler.templates.event_bar_date = function(start, end, evt) {
			return "";
		};

		scheduler.templates.event_bar_text = function(start, end, evt) {
			return "";
		};

		scheduler.templates.event_class = function(start, end, event){
			var original = scheduler.getEvent(event.id);
			//if(!scheduler.isMultisectionEvent(original))
			//	return "";
			return "multisection section_" + event.section_id;
		};


		//===============
		// Tooltip related code
		//===============

		// we want to save "dhx_cal_data" div in a variable to limit look ups
		var scheduler_container = document.getElementById("scheduler_here1");
		var scheduler_container_divs = scheduler_container.getElementsByTagName("div");
		var dhx_cal_data = scheduler_container_divs[scheduler_container_divs.length-1];

		scheduler.isFolderCell = function(target) {
			while (target && target != dhx_cal_data) {
				var cssArr = target.className.split(" "), css=cssArr[0];
				if (cssArr.indexOf("folder") >= 0 || css == "dhx_row_folder") {
					return true;
				}
				target = target.parentNode;
			}
			return false;
		};
		
		// while target has parent node and we haven't reached dhx_cal_data
		// we can keep checking if it is timeline section
		scheduler.dhtmlXTooltip.isTooltipTarget = function(target) {
			while (target.parentNode && target != dhx_cal_data) {
				var css = target.className.split(" ")[0];
				// if we are over matrix cell or tooltip itself
				if (css == "dhx_matrix_scell" || css == "dhtmlXTooltip" || css == "dhx_row_folder") {
					return { classname: css };
				}
				target = target.parentNode;
			}
			return false;
		};

		scheduler.attachEvent("onMouseMove", function(id, e) {
			var timeline_view = scheduler.matrix[scheduler.getState().mode];

			// if we are over event then we can immediately return
			// or if we are not on timeline view
			if (id || !timeline_view) {
				return;
			}

			// native mouse event
			e = e||window.event;
			var target = e.target||e.srcElement;


			//make a copy of event, will be used in timed call, ie8 comp
			var ev = {'pageX':undefined,
				'pageY':undefined,
				'clientX':undefined,
				'clientY':undefined,
				'target':undefined,
				'srcElement':undefined
			};
			for(var i in ev){
				ev[i] = e[i];
			}

			var tooltip = scheduler.dhtmlXTooltip;
			var tooltipTarget = tooltip.isTooltipTarget(target);
			if (tooltipTarget) {

				if (tooltipTarget.classname == "dhx_matrix_scell" || tooltipTarget.classname == "dhx_row_folder") {
					// we are over cell, need to get what cell it is and display tooltip
					var section_id = scheduler.getActionData(e).section;
					var section = timeline_view.y_unit[timeline_view.order[section_id]];

					// showing tooltip itself
					var text = "双击可以弹出设置窗口";
					tooltip.delay(tooltip.show, tooltip, [ev, text]);
				}
				if (tooltipTarget.classname == "dhtmlXTooltip") {


					dhtmlxTooltip.delay(tooltip.show, tooltip, [ev, tooltip.tooltip.innerHTML]);
				}
			}
		});


		//===============
		//Event binding
		//===============
		scheduler.attachEvent("onYScaleClick", function (index, value, event){
			if(scheduler._isRender("tree")) {
				if(!!value.children) {
					//scheduler._toggleFolderDisplay(value.key);			
				}
			}
		});

		scheduler.attachEvent("onYScaleDblClick", function(x, y, evt){
			console.info(arguments);
		});

		scheduler.attachEvent("onCellDblClick", function (x, y, a, b, e) {
			var src = e.target||e.srcElement;			
			if (scheduler.isFolderCell(src)) {
				console.info("onFolderCellDblClick");
			} 
		});


		scheduler._on_cell_click = 	function (e, src){			
			var name = (src.className||"").split(" ")[0];
			switch(name){
				case "dhx_scale_holder":
				case "dhx_scale_holder_now":
				case "dhx_month_body":
				case "dhx_wa_day_data":
					break;
				case "dhx_cal_event":
				case "dhx_wa_ev_body":
				case "dhx_agenda_line":
				case "dhx_grid_event":
				case "dhx_cal_event_line":
				case "dhx_cal_event_clear":
					var id = this._locate_event(src);
					this.deleteEvent(id);					
					break;
				case "dhx_time_block":
				case "dhx_cal_container":
					break;
				case "dhx_matrix_cell":
				case "dhx_marked_timespan":
					var dt = this.getActionData(e);
					var eventExists = false;
					if (dt) {
						var start = dt.date,
						    section_id = dt.section,
						    step = (this.config.event_duration||this.config.time_step)*60000,
						    end = new Date(start.valueOf()+step),
						    evs = this.getEvents(start, end);

						if (evs && evs.length > 0) {
							for(var i=0; i<evs.length; i++) {
								if (section_id == evs[i].section_id) {
									eventExists = true;
									this.deleteEvent(evs[i].id);									
								}
							}
						}
					}
					if (!eventExists) {
						this._on_dbl_click(e);
					}
					break;
				default:
					var t = this["click_"+name];
					if (t) {
						t.call(this,e);
					}
					else {
						if (src.parentNode && src != this)
							return scheduler._on_cell_click(e,src.parentNode);
					}
					break;
			}
		};

		scheduler.attachEvent("onCellClick", function (x, y, a, b, e) {			
			var src = e.target||e.srcElement;			
			if (!scheduler.isFolderCell(src)) {				
				if (this.config.readonly) return;
				this._on_cell_click(e, src);
			}
		});


		//===============
		//Data loading
		//===============
		scheduler.config.lightbox.sections=[	
			{name:"description", height:130, map_to:"text", type:"textarea" , focus:true},
			{name:"custom", height:23, type:"select", options:sections, map_to:"section_id" }
			//{name:"time", height:72, type:"time", map_to:"auto"}
		]

		scheduler.addMarkedTimespan({
			days: [0, 6],
			zones: 'fullday',
			css:'weekend_section'
		});
		
		scheduler.init(el,new Date(2014,5,30), tabbtn);
		scheduler.load("./data/units.xml");

		return scheduler;

	}
</script>

<body onload="init();">
	<div id="" class="well container-fluid" style="height:4%; padding: 1px; margin-bottom: 1px; min-height: 38px;">
		<div class="row" >
			<div class="col-md-3">
				<div class="btn-group" role="group" aria-label="...">
					<button type="button" class="btn btn-default">写报告排班</button>
					<button type="button" class="btn btn-default">审报告排班</button>
				</div>
			</div>		
			<div class="col-md-1"></div>
			<div class="col-md-1"><button type="button" class="btn btn-link btn-block">LINK</button></div>
			<div class="col-md-1"></div>


			<div class="col-md-1"></div>
			<div class="col-md-2"><div class="checkbox"><label><input type="checkbox" id="inlineCheckbox1" value="option1">显示详细</label></div></div>
			<div class="col-md-1"></div>		  
				  
			<div class="col-md-1"></div>
			<div class="col-md-1"><button type="button" class="btn btn-default">打印</button></div>

		</div>

	</div>
	<div id="scheduler_here1" class="dhx_cal_container" style='width:100%; height:90%;'>
		<div class="dhx_cal_navline">
			<div class="dhx_cal_prev_button">&nbsp;</div>
			<div class="dhx_cal_next_button">&nbsp;</div>
			<div class="dhx_cal_today_button"></div>
			<div class="dhx_cal_date"></div>

			<div class="dhx_minical_icon" id="dhx_minical_icon" onclick="show_minical()">&nbsp;</div>

		</div>
		<div class="dhx_cal_header">
		</div>
		<div class="dhx_cal_data">
		</div>		
	</div>
	<div id="" class="well container-fluid" style="height:6%; padding: 8px; min-height:50px; margin-bottom: 1px;">
		<div class="row" >
		  <div class="col-md-2"><button type="button" class="btn btn-link btn-block">LINK</button></div>
		  
		  <div class="col-md-1"><button type="button" class="btn btn-link btn-block">从模板复制</button></div>
		  <div class="col-md-1"><button type="button" class="btn btn-link btn-block">复制前一周</button></div>
		  <div class="col-md-1"><button type="button" class="btn btn-link btn-block">复制前两周</button></div>
		  <div class="col-md-1"></div>
		  <div class="col-md-1"><button type="button" class="btn btn-default">导入EXCEL</button></div>
		  <div class="col-md-1"><button type="button" class="btn btn-default">导出EXCEL</button></div>
		  <div class="col-md-1"><button type="button" class="btn btn-default">另存为模板</button></div>
		  <div class="col-md-1"></div>
		  
		  <div class="col-md-1"><button type="button" class="btn btn-danger btn-block">重 置</button></div>
		  <div class="col-md-1"><button type="button" class="btn btn-success btn-block">保 存</button></div>
		  <div class="col-md-1"></div>
		</div>

	</div>
</body>